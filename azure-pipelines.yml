# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
  branches:
    include:
      - main


pool:
  name: UniCircle

variables:
  frontend: Frontend
  backend: Backend

steps:
 - task: NodeTool@0
   inputs:
     versionSource: 'spec'
     versionSpec: '22.x'
   displayName: 'Use Node.js 22'

 - script: |
    set JAVA_HOME=D:\Coding\jdk 21
    set PATH=%JAVA_HOME%\bin;%PATH%
    java -version
   displayName: "Set JAVA_HOME for Backend"

 - powershell: |
    cd $(Build.SourcesDirectory)\$(frontend)
    npm install
    npm run build
    Get-ChildItem -Recurse dist
   displayName: 'Build React frontend and list dist folder'

 - powershell: |
    Copy-Item -Path "$(Build.SourcesDirectory)\$(frontend)\dist\*" `
               -Destination "$(Build.SourcesDirectory)\$(backend)\src\main\resources\static" `
               -Recurse -Force
   displayName: 'Copy Vite dist to Spring Boot static directory'

 - script: |
    cd $(backend)
    .\gradlew.bat clean bootJar -x test
   displayName: 'Build Spring Boot for UniCircle Backend'

 - task: PublishBuildArtifacts@1
   inputs:
    PathtoPublish: '$(backend)\build\libs'
    ArtifactName: 'drop'
   displayName: 'Publish build artifact'

 - task: AzureWebApp@1
   inputs:
    azureSubscription: 'UniCircle-Azure-Connection'
    appName: 'UniCircle'
    package: '$(backend)/build/libs/*.jar'
    appType: 'webApp'




